<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel — Skill Central</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a855f7'><path d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>" />
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Verdana, sans-serif; background: linear-gradient(180deg, rgba(13, 17, 23, 1) 0%, rgba(15, 19, 25, 0.98) 100%); color: #e6edf3; min-height: 100vh; }
      .admin-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
      .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(48, 54, 61, 0.4); }
      .admin-header h1 { margin: 0; font-size: 2rem; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
      .back-btn { background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
      .back-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(88, 166, 255, 0.3); }
      .admin-section { background: linear-gradient(135deg, rgba(30, 30, 30, 0.8) 0%, rgba(40, 40, 40, 0.6) 100%); border: 1px solid rgba(48, 54, 61, 0.4); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; backdrop-filter: blur(15px); }
      .admin-section h2 { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.3rem; color: #a855f7; }
      .form-group { margin-bottom: 1.5rem; }
      .form-label { display: block; font-weight: 600; margin-bottom: 0.75rem; color: #e6edf3; }
      .form-input, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid rgba(48, 54, 61, 0.6); border-radius: 8px; background: rgba(20, 20, 20, 0.8); color: #e6edf3; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; }
      .form-input:focus, .form-textarea:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 12px rgba(168, 85, 247, 0.2); }
      .form-textarea { resize: vertical; min-height: 100px; }
      .btn { border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-block; }
      .btn-primary { background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); color: white; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3); }
      .btn-success { background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%); color: white; margin-right: 0.5rem; }
      .btn-success:hover { transform: translateY(-2px); }
      .btn-danger { background: linear-gradient(135deg, #f85149 0%, #da3633 100%); color: white; }
      .btn-danger:hover { transform: translateY(-2px); }
      .btn-secondary { background: rgba(88, 166, 255, 0.1); color: #58a6ff; border: 1px solid #58a6ff; }
      .btn-secondary:hover { background: rgba(88, 166, 255, 0.2); }
      .topics-list { margin-top: 1.5rem; }
      .topic-item { background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(48, 54, 61, 0.4); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
      .topic-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
      .topic-title { font-weight: 700; font-size: 1.1rem; color: #a855f7; }
      .topic-desc { color: #8b949e; font-size: 0.9rem; margin-bottom: 1rem; }
      .topic-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
      .error-msg { background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; color: #f85149; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
      .success-msg { background: rgba(88, 166, 255, 0.1); border: 1px solid #58a6ff; color: #58a6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>Admin Panel</h1>
        <button class="back-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
      </div>

      <div id="error-msg" class="error-msg" style="display: none;"></div>
      <div id="success-msg" class="success-msg" style="display: none;"></div>

      <!-- Create Topic Form -->
      <div class="admin-section">
        <h2>Create New Topic</h2>
        <form id="create-topic-form">
          <div class="form-group">
            <label class="form-label">Topic Name</label>
            <input type="text" id="topic-name" class="form-input" placeholder="e.g., Python Basics" required>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="topic-desc" class="form-textarea" placeholder="Brief description of the topic" required></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Image URL</label>
            <input type="text" id="topic-image" class="form-input" placeholder="https://example.com/image.jpg" required>
          </div>

          <button type="submit" class="btn btn-primary">Create Topic</button>
        </form>
      </div>

      <!-- Topics Management -->
      <div class="admin-section">
        <h2>Manage Topics</h2>
        <div id="topics-list" class="topics-list"></div>
      </div>

      <!-- Admin Import -->
      <div class="admin-section">
        <h2>Import Admins</h2>
        <p style="color:#9aa4b2;">Import a list of admin emails from a GitHub Gist file named <code>admins.json</code>.</p>
        <div class="form-group">
          <label class="form-label">Admins Gist ID</label>
          <input type="text" id="admins-gist-id" class="form-input" placeholder="Enter Gist ID containing admins.json" />
        </div>
        <div class="form-group">
          <label class="form-label">GitHub Token (optional)</label>
          <input type="text" id="admins-gist-token" class="form-input" placeholder="Personal Access Token (gist scope)" />
        </div>
        <button id="load-admins" class="btn btn-primary">Load Admins from Gist</button>
        <div id="admins-msg" style="margin-top:0.75rem;color:#9aa4b2;"></div>
      </div>
      
      <!-- Admins Management -->
      <div class="admin-section">
        <h2>Admins Management</h2>
        <p style="color:#9aa4b2;">View and manage admin emails. Emails are masked by default to protect privacy.</p>
        <div id="admins-list" style="margin-top:1rem;color:#e6edf3;"></div>
        <div style="margin-top:1rem;display:flex;gap:0.5rem;align-items:center;">
          <input id="export-admins-token" placeholder="GitHub token (for export)" class="form-input" style="flex:1;" />
          <button id="export-admins" class="btn btn-secondary">Export Admins to Gist</button>
        </div>
        <small style="color:#9aa4b2;display:block;margin-top:0.75rem;">Export creates a gist named <code>admins.json</code> containing the admin email array.</small>
      </div>
    </div>

    <script>
      // Check admin status (support sessionStorage and localStorage)
      const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
      const isAdminFlag = (localStorage.getItem('isAdmin') === 'true') || (sessionStorage.getItem('isAdmin') === 'true') || (JSON.parse(localStorage.getItem('admins') || '[]').includes(currentUser));

      if (!currentUser || !isAdminFlag) {
        window.location.href = 'dashboard.html';
      }

      function getTopics() {
        return JSON.parse(localStorage.getItem('topics') || '[]');
      }

      function saveTopics(topics) {
        localStorage.setItem('topics', JSON.stringify(topics));
      }

      function showMessage(msg, type) {
        const msgEl = document.getElementById(type === 'error' ? 'error-msg' : 'success-msg');
        msgEl.textContent = msg;
        msgEl.style.display = 'block';
        setTimeout(() => msgEl.style.display = 'none', 3000);
      }

      function renderTopics() {
        const topics = getTopics();
        const container = document.getElementById('topics-list');

        if (topics.length === 0) {
          container.innerHTML = '<p style="color: #8b949e; text-align: center;">No topics yet. Create one to get started!</p>';
          return;
        }

        container.innerHTML = topics.map((topic, idx) => `
          <div class="topic-item">
            <div class="topic-header">
              <div>
                <div class="topic-title">${topic.name}</div>
                <div class="topic-desc">${topic.description}</div>
              </div>
            </div>
            <div>
              <strong style="color: #79c0ff;">Lessons: ${((topic.subjects||[]).reduce((s,sub)=> s + (sub.lessons||[]).length,0))}</strong>
            </div>
            <div class="topic-actions" style="margin-top: 1rem;">
              <button class="btn btn-success" onclick="editTopic(${idx})">Edit</button>
              <button class="btn btn-secondary" onclick="manageLessons(${idx})">Manage Lessons</button>
              <button class="btn btn-danger" onclick="deleteTopic(${idx})">Delete</button>
            </div>
          </div>
        `).join('');
      }

      function editTopic(idx) {
        const topics = getTopics();
        const topic = topics[idx];

        // Build modal to edit topic fields and subjects
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed'; overlay.style.inset = 0; overlay.style.background = 'rgba(0,0,0,0.6)'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.zIndex = 2000;
        const modal = document.createElement('div');
        modal.style.width = '720px'; modal.style.maxWidth = '95%'; modal.style.background = 'linear-gradient(180deg,#0b0f13,#0f1317)'; modal.style.border = '1px solid rgba(255,255,255,0.04)'; modal.style.padding = '1.25rem'; modal.style.borderRadius = '12px'; modal.style.color = '#e6edf3';

        const subjectsHtml = (topic.subjects || []).map((s, si) => `
          <div class="subject-edit-row" data-idx="${si}" style="margin-bottom:0.5rem;display:flex;gap:0.5rem;align-items:flex-start;">
            <input class="subject-name" value="${escapeHtml(s.name)}" placeholder="Subject name" style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;" />
            <button class="btn btn-danger remove-subj">Remove</button>
          </div>
        `).join('');

        modal.innerHTML = `
          <h3 style="margin-top:0;">Edit Topic — ${escapeHtml(topic.name)}</h3>
          <div style="display:flex;flex-direction:column;gap:0.75rem;margin-top:0.75rem;">
            <input id="modal-topic-name" placeholder="Topic name" value="${escapeHtml(topic.name)}" style="padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;" />
            <textarea id="modal-topic-desc" placeholder="Description" style="min-height:80px;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;">${escapeHtml(topic.description||'')}</textarea>
            <input id="modal-topic-image" placeholder="Image URL" value="${escapeHtml(topic.image||'')}" style="padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;" />
            <h4 style="margin:0.25rem 0 0 0;color:#9aa4b2;">Subjects</h4>
            <div id="modal-subjects" style="max-height:180px;overflow:auto;padding:0.5rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.2);">${subjectsHtml}</div>
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
              <button id="modal-add-subj" class="btn btn-secondary">Add Subject</button>
              <button id="modal-cancel-topic" class="btn btn-secondary">Cancel</button>
              <button id="modal-save-topic" class="btn btn-primary">Save Topic</button>
            </div>
          </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Helpers
        function refreshRemoveButtons() {
          modal.querySelectorAll('.remove-subj').forEach(btn => {
            btn.onclick = (e) => e.target.closest('.subject-edit-row').remove();
          });
        }
        refreshRemoveButtons();

        document.getElementById('modal-add-subj').addEventListener('click', () => {
          const cont = document.getElementById('modal-subjects');
          const idx = cont.querySelectorAll('.subject-edit-row').length;
          const row = document.createElement('div');
          row.className = 'subject-edit-row'; row.dataset.idx = idx;
          row.style = 'margin-bottom:0.5rem;display:flex;gap:0.5rem;align-items:flex-start;';
          row.innerHTML = `<input class="subject-name" placeholder="Subject name" style="flex:1;padding:0.5rem;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;" /><button class="btn btn-danger remove-subj">Remove</button>`;
          cont.appendChild(row);
          refreshRemoveButtons();
        });

        document.getElementById('modal-cancel-topic').addEventListener('click', () => overlay.remove());

        document.getElementById('modal-save-topic').addEventListener('click', () => {
          const name = document.getElementById('modal-topic-name').value.trim();
          const desc = document.getElementById('modal-topic-desc').value.trim();
          const image = document.getElementById('modal-topic-image').value.trim();
          if (!name) return alert('Topic must have a name');
          const subjEls = Array.from(document.querySelectorAll('#modal-subjects .subject-edit-row'));
          const subjects = subjEls.map(el => ({ name: (el.querySelector('.subject-name')?.value || '').trim(), lessons: [] })).filter(s => s.name);
          topics[idx] = { ...topic, name, description: desc, image, subjects };
          saveTopics(topics);
          renderTopics();
          overlay.remove();
          showMessage('Topic updated successfully!', 'success');
        });
      }

      function deleteTopic(idx) {
        // Require re-authentication before destructive actions
        requireReauth().then(confirmed => {
          if (!confirmed) return;
          if (!confirm('Are you sure? This will delete all lessons in this topic.')) return;
          const topics = getTopics();
          topics.splice(idx, 1);
          saveTopics(topics);
          renderTopics();
          showMessage('Topic deleted successfully!', 'success');
        }).catch(err => alert(err.message || err));
      }

      // Simple re-auth modal: ask for password and verify against stored user hash
      async function hashPasswordLocal(pwd) {
        const encoder = new TextEncoder();
        const data = encoder.encode(pwd);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      }

      function requireReauth() {
        return new Promise((resolve, reject) => {
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed'; overlay.style.inset = 0; overlay.style.background = 'rgba(0,0,0,0.6)'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.zIndex = 3000;
          const modal = document.createElement('div');
          modal.style.width = '420px'; modal.style.maxWidth = '95%'; modal.style.background = 'linear-gradient(180deg,#0b0f13,#0f1317)'; modal.style.border = '1px solid rgba(255,255,255,0.04)'; modal.style.padding = '1rem'; modal.style.borderRadius = '12px'; modal.style.color = '#e6edf3';
          modal.innerHTML = `<h4 style="margin-top:0;">Re-authenticate</h4><p style="color:#9aa4b2;">Enter your password to confirm this action.</p><input id="reauth-pwd" type="password" placeholder="Password" style="width:100%;padding:0.6rem;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;" /><div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.75rem;"><button id="reauth-cancel" class="btn btn-secondary">Cancel</button><button id="reauth-confirm" class="btn btn-primary">Confirm</button></div>`;
          overlay.appendChild(modal); document.body.appendChild(overlay);
          document.getElementById('reauth-cancel').addEventListener('click', () => { overlay.remove(); resolve(false); });
          document.getElementById('reauth-confirm').addEventListener('click', async () => {
            const pwd = document.getElementById('reauth-pwd').value || '';
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (!savedUser) { overlay.remove(); return reject(new Error('No user signed in')); }
            const hashed = await hashPasswordLocal(pwd);
            const found = users.find(u => (u.email === savedUser) && (u.password === hashed));
            overlay.remove();
            if (found) return resolve(true);
            return resolve(false);
          });
        });
      }

      // Admin list rendering and export
      function maskEmail(email) {
        if (!email) return '';
        const parts = email.split('@');
        const name = parts[0];
        const domain = parts[1] || '';
        if (name.length <= 2) return name[0] + '***@' + domain;
        return name.slice(0,2) + '***@' + domain;
      }

      function renderAdminsList() {
        const list = JSON.parse(localStorage.getItem('admins') || '[]');
        const el = document.getElementById('admins-list');
        if (!el) return;
        if (list.length === 0) { el.innerHTML = '<p style="color:#8b949e;">No admins configured.</p>'; return; }
        el.innerHTML = list.map((a,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px dashed rgba(255,255,255,0.03);"><div>${maskEmail(a)}</div><div style="display:flex;gap:0.5rem;"><button class="btn btn-secondary" data-idx="${i}" data-email="${a}" onclick="revealAdmin(this)">Reveal</button><button class="btn btn-danger" data-idx="${i}" onclick="removeAdmin(${i})">Remove</button></div></div>`).join('');
      }

      window.revealAdmin = function(btn) {
        // Require reauth to reveal full email
        requireReauth().then(ok => {
          if (!ok) return alert('Re-authentication failed');
          const email = btn.dataset.email;
          navigator.clipboard?.writeText(email).then(()=> alert('Email copied to clipboard'));
        }).catch(e => alert(e.message||e));
      };

      window.removeAdmin = function(i) {
        requireReauth().then(ok => {
          if (!ok) return alert('Re-authentication failed');
          const admins = JSON.parse(localStorage.getItem('admins') || '[]');
          admins.splice(i,1);
          localStorage.setItem('admins', JSON.stringify(admins));
          renderAdminsList();
          showMessage('Admin removed', 'success');
        }).catch(e => alert(e.message||e));
      };

      document.getElementById('export-admins')?.addEventListener('click', async () => {
        const token = document.getElementById('export-admins-token').value.trim();
        if (!token) return alert('Provide a GitHub token with gist scope to export');
        try {
          const admins = JSON.parse(localStorage.getItem('admins') || '[]');
          const body = { description: 'Skill-Central admins export', public: false, files: { 'admins.json': { content: JSON.stringify(admins, null, 2) } } };
          const res = await fetch('https://api.github.com/gists', { method: 'POST', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!res.ok) throw new Error('Gist creation failed: ' + res.statusText);
          const data = await res.json();
          alert('Admins exported: ' + data.html_url + '\nGist ID: ' + data.id);
        } catch (e) { alert(e.message || e); }
      });

      // Initial render of admin list
      renderAdminsList();

      // Open a modal editor to add/edit a lesson (nice UI)
      function manageLessons(idx, lessonIdx = -1) {
        const topics = getTopics();
        const topic = topics[idx];

        // Build modal
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed'; overlay.style.inset = 0; overlay.style.background = 'rgba(0,0,0,0.6)'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.zIndex = 2000;
        const modal = document.createElement('div');
        modal.style.width = '720px'; modal.style.maxWidth = '95%'; modal.style.background = 'linear-gradient(180deg,#0b0f13,#0f1317)'; modal.style.border = '1px solid rgba(255,255,255,0.04)'; modal.style.padding = '1.5rem'; modal.style.borderRadius = '12px'; modal.style.color = '#e6edf3';

        // Ensure subjects array exists; use first subject for simple management
        if (!topic.subjects) topic.subjects = [{ name: 'General', lessons: [] }];
        const subject = topic.subjects[0];
        const lesson = (lessonIdx >= 0 && subject.lessons && subject.lessons[lessonIdx]) ? subject.lessons[lessonIdx] : { title: '', content: '', type: 'article', image: '', questions: [], revisions: [] };

        modal.innerHTML = `
          <h3 style="margin-top:0;">${lessonIdx>=0 ? 'Edit' : 'Add'} Lesson — ${topic.name}</h3>
          <div style="display:flex;flex-direction:column;gap:0.75rem;margin-top:0.75rem;">
            <input id="modal-lesson-title" placeholder="Title" value="${escapeHtml(lesson.title)}" style="padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;" />
            <textarea id="modal-lesson-content" placeholder="Content" style="min-height:120px;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;">${escapeHtml(lesson.content)}</textarea>
            <input id="modal-lesson-image" placeholder="Image URL" value="${escapeHtml(lesson.image||'')}" style="padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;" />
            <input id="modal-lesson-type" placeholder="Type (video/article/quiz)" value="${escapeHtml(lesson.type||'article')}" style="padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;" />
            <label style="font-size:0.9rem;color:#9aa4b2;">Questions (one per line, format: question|answer)</label>
            <textarea id="modal-lesson-questions" placeholder="q1|a1\nq2|a2" style="min-height:80px;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;">${escapeHtml((lesson.questions||[]).map(q=> (q.q||q.question)+'|'+(q.a||q.answer)).join('\n'))}</textarea>
            <label style="font-size:0.9rem;color:#9aa4b2;">Revisions (one per line)</label>
            <textarea id="modal-lesson-revisions" placeholder="Revision note per line" style="min-height:60px;padding:0.6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;">${escapeHtml((lesson.revisions||[]).join('\n'))}</textarea>
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
              <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
              <button id="modal-save" class="btn btn-success">Save Lesson</button>
            </div>
          </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        document.getElementById('modal-cancel').addEventListener('click', () => overlay.remove());
        document.getElementById('modal-save').addEventListener('click', () => {
          const title = document.getElementById('modal-lesson-title').value.trim();
          const content = document.getElementById('modal-lesson-content').value.trim();
          const image = document.getElementById('modal-lesson-image').value.trim();
          const type = document.getElementById('modal-lesson-type').value.trim() || 'article';
          const questionsRaw = document.getElementById('modal-lesson-questions').value.trim();
          const revisionsRaw = document.getElementById('modal-lesson-revisions').value.trim();

          if (!title) return alert('Please provide a title for the lesson.');

          const questions = questionsRaw ? questionsRaw.split('\n').map(line => {
            const [q,a] = line.split('|'); return { question: (q||'').trim(), answer: (a||'').trim() };
          }).filter(x=>x.question) : [];
          const revisions = revisionsRaw ? revisionsRaw.split('\n').map(r=>r.trim()).filter(Boolean) : [];

          const newLesson = { title, content, image, type, questions, revisions };
          if (!subject.lessons) subject.lessons = [];
          if (lessonIdx >= 0) subject.lessons[lessonIdx] = newLesson; else subject.lessons.push(newLesson);
          topics[idx] = topic;
          saveTopics(topics);
          renderTopics();
          overlay.remove();
          showMessage('Lesson saved.', 'success');
        });
      }

      function escapeHtml(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      document.getElementById('create-topic-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('topic-name').value.trim();
        const desc = document.getElementById('topic-desc').value.trim();
        const image = document.getElementById('topic-image').value.trim();

        if (!name || !desc || !image) {
          showMessage('Please fill in all fields', 'error');
          return;
        }

        const topics = getTopics();
        topics.push({ name, description: desc, image, subjects: [{ name: 'General', lessons: [] }] });
        saveTopics(topics);

        document.getElementById('create-topic-form').reset();
        renderTopics();
        showMessage('Topic created successfully!', 'success');
      });

      // Wire up admin imports (admins.json from a Gist)
      const loadAdminsBtn = document.getElementById('load-admins');
      const adminsGistIdInput = document.getElementById('admins-gist-id');
      const adminsGistTokenInput = document.getElementById('admins-gist-token');
      const adminsMsg = document.getElementById('admins-msg');

      loadAdminsBtn?.addEventListener('click', async () => {
        const gid = adminsGistIdInput.value.trim();
        const token = adminsGistTokenInput.value.trim();
        if (!gid) return alert('Enter the Gist ID that contains admins.json');
        try {
          loadAdminsBtn.disabled = true;
          // loadAdminsFromGist is defined in assets/script.js
          await loadAdminsFromGist(gid, token || null);
          adminsMsg.textContent = 'Admins imported successfully.';
          renderTopics();
        } catch (e) {
          alert(e.message);
        } finally { loadAdminsBtn.disabled = false; }
      });

      renderTopics();
    </script>
  </body>
</html>
